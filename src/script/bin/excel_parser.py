from datetime import datetime
import os

from pandas import DataFrame

from src.script.bin.arguments import Arguments
import openpyxl
import pandas
import pandasql
from openpyxl.styles import Alignment, Font


def is_empty_integer(v) -> bool:
    return v is None or isinstance(v, int) or v.isdigit()


class ExcelParser(Arguments):
    def __init__(self):
        super().__init__()
        self.ACTIVITIES = ["MIC", "MBC", "MICb", "gentamicin"]
        self.ITEMS = [1, 2, 3, 1, 2, 3, 1, 2, 3, 1]
        self.COLUMNS = ["sheet", "row_id", "code", "pathogen", "activity", "item", "item_value", "timestamp"]
        self.COLUMNS_ERR = ["sheet", "cell", "actual value", "error_description"]
        self.ITEM_COL_OFFSET = 2
        self.MINIMAL_CODE_LEN = 6
        self.SQL = """
                SELECT pathogen, code, item_value, count(item_value) as cnt_item 
                    FROM raw_data 
                    WHERE activity = '{activity}', 
                GROUP BY pathogen, code, activity, item_value
                HAVING count(item_value) > 1
            """

    def is_code(self, val) -> bool:
        v = str(val)
        res = v is not None and (v.partition("-")[1] == '-') and v.partition("-")[0].lstrip().rstrip().isdigit() and len(str(v.partition("-")[2])) > self.MINIMAL_CODE_LEN
        return res

    def get_raw_data(self, wbi: openpyxl.workbook.Workbook) -> pandas.DataFrame:
        # todo add type_essay column, add timestamp
        timestamp: str = datetime.now().strftime('%Y-%m-%d_%H:%M:%S')
        code = ""
        activity = ""
        raw_data = pandas.DataFrame(columns=self.COLUMNS)
        self.log.info(f"There is {len(self.p.sheets)} sheet(s) selected.")
        for sheet_name in self.p.sheets:
            self.log.info(f"Building data for Excel worksheet {str(sheet_name)}.")
            for row_number in range(1, wbi[str(sheet_name)].max_row):
                lead = wbi[sheet_name].cell(row=row_number, column=2)
                if lead.value:
                    row_id = lead.value
                    if int(lead.value) == 1:
                        raw_code = str(lead.offset(row=-3, column=2).value)
                        code = (raw_code.partition("-")[2]).lstrip().rstrip()
                    pathogen = lead.offset(row=0, column=1).value
                    activity_id = 0
                    for item_id, item in enumerate(self.ITEMS):
                        if item == 1:
                            activity = self.ACTIVITIES[activity_id]
                            activity_id += 1
                        item_v = str(lead.offset(row=0, column=self.ITEM_COL_OFFSET + item_id).value)
                        raw_data.loc[len(raw_data)] = [str(sheet_name), row_id, code, pathogen, activity, item, item_v,timestamp]
        return raw_data

    def approve_data(self, wbi) -> pandas.DataFrame:
        report_err = pandas.DataFrame(columns=self.COLUMNS_ERR)
        for sheet_name in self.p.sheets:
            for row_number in range(1, wbi[str(sheet_name)].max_row):
                lead = wbi[sheet_name].cell(row=row_number, column=2)
                if not is_empty_integer(lead.value):
                    report_err.loc[len(report_err)] = [str(sheet_name), f"B{row_number}", str(lead.value),
                                                       "Integer number expected"]
                elif not lead.value is None and int(lead.value) == 1:
                    try:
                        raw_code = str(lead.offset(row=-3, column=2).value)
                        if not self.is_code(raw_code):
                            report_err.loc[len(report_err)] = [str(sheet_name), f"D{row_number - 3}", str(raw_code), "The format of raw code could be '# - code'"]
                    except ValueError as e:
                        report_err.loc[len(report_err)] = [str(sheet_name), f"B{row_number}", str(lead.value), f"Wrong position of leading '1' {e}"]
        if len(report_err) > 0:
            self.log.warning("Errors found and will ge reported.")
            err = set(report_err['sheet'])
            valid = ", ".join(set(self.p.sheets) - err)
            err = ",".join(err)
            self.log.error(f"The sheets with errors: '{err}'")
            self.log.info(f"The valid sheets without errors: '{valid}'")
        return report_err

    def get_final_content(self, raw_data: pandas.DataFrame) -> dict:
        # todo add multiple sheets named by list type_essay from type_essay column from raw data
        res = dict()
        for tpe in self.p.type_essay:
            limited_data: pandas.DataFrame = raw_data[['pathogen', 'code', 'item', 'item_value', 'timestamp']]
            sql = self.SQL.format(activity = tpe)
            build_item_value: pandas.DataFrame = pandasql.sqldf(sql, locals())
            build_item_value.pivot_table(values='item_value', index=['code'], columns=['pathogen'], aggfunc="first")
            res.update({tpe: build_item_value})
        return res

    def excel_final(self, workbook_data: dict) -> None:
        # todo add content with list type_essay to Excel final
        for sheet in workbook_data:
            content = workbook_data[sheet]
        # self.save_file(tba, self.p.export_excel_file)


    def excel_final_formatting(self) -> None:
        # todo formate each sheet named by list type_essay from type_essay column from raw data
        wb = openpyxl.load_workbook(self.p.export_excel_file, read_only=False)
        ws = wb.active
        for c in ws['A1':'AA1'][0]:
            c.alignment = Alignment(textRotation=90)
            c.font = Font(bold=False)
        wb.save(filename=self.p.export_excel_file)

    def check_file(self, file_path) -> bool:
        directory = os.path.dirname(file_path)
        if directory:
            if not os.path.exists(directory):
                try:
                    os.makedirs(directory)
                    self.log.warning(f"New directory created: '{directory}'")
                except Exception as e:
                    print(f"Error creating directory '{directory}': {e}")
                    exit(0)
        return os.path.exists(file_path)

    def append_raw_data(self, wbi: openpyxl.workbook.workbook.Workbook ) -> DataFrame | None:
        raw_data = self.get_raw_data(wbi)
        if not self.check_file(self.p.raw_data):
            self.save_file(raw_data.to_excel if self.p.ext == self.EXCEL_EXTENSION else raw_data.to_csv, self.p.export_raw_file)
            try:
                if self.p.ext == self.EXCEL_EXTENSION:
                    raw_data.to_excel(self.p.raw_data)
                else:
                    raw_data.to_csv(self.p.raw_data)
                return raw_data
            except Exception as e:
                self.log.warning(f"Error saving data to new file '{self.p.raw_data}': {e}")
                exit(1)
        else:
            #todo append data to existing scv/ excel file
            try:
                if self.p.ext == self.EXCEL_EXTENSION:
                    ws = wbi.active
                    ws.append(raw_data.itertuples(index=False))
                    wbi.save(filename=self.p.raw_data)
                else:
                    pass

            except Exception as e:
                self.log.warning(f"Error adding data to file '{self.p.raw_data}': {e}")
                exit(1)
